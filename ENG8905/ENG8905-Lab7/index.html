<!DOCTYPE html>
<html  dir="ltr">

    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <title>ENG 8905 - Quadrature Encoders Part 1 The Knob</title>
        <link rel="shortcut icon" href="images/favicon.ico" type="image/x-icon">
        <link rel="apple-touch-icon-precomposed" href="images/apple-touch-icon.png">

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/uikit/2.26.4/css/uikit.gradient.css">

        <!-- <link rel="stylesheet" href="style.css"> -->
        <link rel="stylesheet" href="https://cdn.rawgit.com/diversen/pandoc-uikit/master/style.css">
        <link href="https://vjs.zencdn.net/5.4.4/video-js.css" rel="stylesheet" />
        <script src="https://code.jquery.com/jquery-2.2.1.min.js"></script>
        <!-- <script src="uikit.js"></script> -->
        <script src="https://cdn.rawgit.com/diversen/pandoc-uikit/master/uikit.js"></script>
        <!-- <script src="scripts.js"></script> -->
        <script src="https://cdn.rawgit.com/diversen/pandoc-uikit/master/scripts.js"></script>
        <!-- <script src="jquery.sticky-kit.js "></script> -->
        <script src="https://cdn.rawgit.com/diversen/pandoc-uikit/master/jquery.sticky-kit.js"></script>

        <meta name="generator" content="pandoc-uikit" />
                <meta name="author" content="Kyle Chisholm" />
                        <meta name="date" content="2022-05-01" />
                <title>ENG 8905 - Quadrature Encoders Part 1 The Knob</title>
        <style type="text/css">code{white-space: pre;}</style>
                        <style type="text/css">
            a.sourceLine { display: inline-block; line-height: 1.25; }
            a.sourceLine { pointer-events: none; color: inherit; text-decoration: inherit; }
            a.sourceLine:empty { height: 1.2em; }
            .sourceCode { overflow: visible; }
            code.sourceCode { white-space: pre; position: relative; }
            div.sourceCode { margin: 1em 0; }
            pre.sourceCode { margin: 0; }
            @media screen {
            div.sourceCode { overflow: auto; }
            }
            @media print {
            code.sourceCode { white-space: pre-wrap; }
            a.sourceLine { text-indent: -1em; padding-left: 1em; }
            }
            pre.numberSource a.sourceLine
              { position: relative; left: -4em; }
            pre.numberSource a.sourceLine::before
              { content: attr(title);
                position: relative; left: -1em; text-align: right; vertical-align: baseline;
                border: none; pointer-events: all; display: inline-block;
                -webkit-touch-callout: none; -webkit-user-select: none;
                -khtml-user-select: none; -moz-user-select: none;
                -ms-user-select: none; user-select: none;
                padding: 0 4px; width: 4em;
                color: #aaaaaa;
              }
            pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
            div.sourceCode
              { background-color: #f8f8f8; }
            @media screen {
            a.sourceLine::before { text-decoration: underline; }
            }
            code span.al { color: #ef2929; } /* Alert */
            code span.an { color: #8f5902; font-weight: bold; font-style: italic; } /* Annotation */
            code span.at { color: #c4a000; } /* Attribute */
            code span.bn { color: #0000cf; } /* BaseN */
            code span.cf { color: #204a87; font-weight: bold; } /* ControlFlow */
            code span.ch { color: #4e9a06; } /* Char */
            code span.cn { color: #000000; } /* Constant */
            code span.co { color: #8f5902; font-style: italic; } /* Comment */
            code span.cv { color: #8f5902; font-weight: bold; font-style: italic; } /* CommentVar */
            code span.do { color: #8f5902; font-weight: bold; font-style: italic; } /* Documentation */
            code span.dt { color: #204a87; } /* DataType */
            code span.dv { color: #0000cf; } /* DecVal */
            code span.er { color: #a40000; font-weight: bold; } /* Error */
            code span.ex { } /* Extension */
            code span.fl { color: #0000cf; } /* Float */
            code span.fu { color: #000000; } /* Function */
            code span.im { } /* Import */
            code span.in { color: #8f5902; font-weight: bold; font-style: italic; } /* Information */
            code span.kw { color: #204a87; font-weight: bold; } /* Keyword */
            code span.op { color: #ce5c00; font-weight: bold; } /* Operator */
            code span.ot { color: #8f5902; } /* Other */
            code span.pp { color: #8f5902; font-style: italic; } /* Preprocessor */
            code span.sc { color: #000000; } /* SpecialChar */
            code span.ss { color: #4e9a06; } /* SpecialString */
            code span.st { color: #4e9a06; } /* String */
            code span.va { color: #000000; } /* Variable */
            code span.vs { color: #4e9a06; } /* VerbatimString */
            code span.wa { color: #8f5902; font-weight: bold; font-style: italic; } /* Warning */
        </style>
                                            <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.9/MathJax.js?config=TeX-AMS_CHTML" type="text/javascript"></script>
                                </head>

    <body>


        <div class="uk-container uk-container-center uk-margin-top uk-margin-large-bottom">

                        <div class="uk-grid" data-uk-grid-margin>
                <div class="uk-width-1-1">
                    <h1 class="uk-heading-large">ENG 8905 - Quadrature Encoders Part 1 The Knob</h1>
                                        <h3>2022-05-01</p></h3>
                                                            <p class="uk-text-large">Kyle Chisholm</p>
                                    </div>
            </div>
            
            <div class="uk-grid" data-uk-grid-margin >          
                <div class="uk-width-medium-1-4">
                    <div class="uk-overflow-container" data-uk-sticky="{top:25,media: 768}">
                        <div class="uk-panel uk-panel-box menu-begin" >

                                                        <ul>
                            <li><a href="#background">Background</a><ul>
                            <li><a href="#quadrature-and-absolute-encoders">Quadrature and Absolute Encoders</a></li>
                            <li><a href="#gray-code-decoding">Gray-Code Decoding</a></li>
                            </ul></li>
                            <li><a href="#materials">Materials</a></li>
                            <li><a href="#methods">Methods</a><ul>
                            <li><a href="#raspberry-pi-system-software-prerequisites">Raspberry Pi System Software Prerequisites</a></li>
                            <li><a href="#lab-software-requirements">Lab Software Requirements</a></li>
                            <li><a href="#test-the-hardware-and-run-python-scripts">Test The Hardware and Run Python Scripts</a></li>
                            <li><a href="#coding-task-decode-quadrature-input">Coding Task: Decode Quadrature Input</a></li>
                            <li><a href="#data-collection">Data Collection</a></li>
                            </ul></li>
                            <li><a href="#analysis">Analysis</a></li>
                            <li><a href="#submission-guidelines">Submission Guidelines</a></li>
                            </ul>
                            
                        </div>
                    </div>
                </div>

                <div class="uk-width-medium-3-4">
<p>Decoding a quadrature incremental encoder to measure position of a knob. A custom implementation of the decoding logic is compared against a published Python package.</p>
<p><strong>Submission Deadline</strong>: May 01, 2022</p>
<p><strong>Online version of this document</strong>: <a href="https://chishok.github.io/ENG8905/ENG8905-Lab7">https://chishok.github.io/ENG8905/ENG8905-Lab7</a></p>
<h2 id="background">Background</h2>
<p><a href="https://en.wikipedia.org/wiki/Incremental_encoder">Incremental encoders</a> are everywhere, used for high-precision motion control applications such as robotics or radar systems and also for simple interfaces like volume knobs. A rotary encoder repeats a signal sequentially “high” then “low” as it rotates. The signals are generated by various physical means, including magnetic, optical, and mechanical interfaces.</p>
<p>An <strong>optical encoder</strong> involves placing a light emitter and a received on either sides of an opaque disc, with open slots cut out at regular angle intervals. When the disc rotates, the receiver will register the light in a sequential on and off pattern as shown in Figure <a href="#fig:optical-encoder">1</a>.</p>
<div id="fig:optical-encoder" class="fignos">
<figure>
<img src="optical-encoder.jpg" alt="Figure 1: Optical Encoder" /><figcaption><span>Figure 1:</span> Optical Encoder</figcaption>
</figure>
</div>
<p>The rising and/or falling edges of the one/off square wave pattern are counted by a <strong>decoder</strong>, which can be implemented as a simple integrated circuit or part of microcontroller code. In this lab we will be using the Raspberry Pi GPIO and Python to count encoder signal edges.</p>
<p>A <strong>mechanical encoder</strong> uses physical conductive contacts that brush up one another to generate the on and off (high and low) signals as it rotates. This lab will utilize a mechanical encoder <a href="https://components101.com/modules/KY-04-rotary-encoder-pinout-features-datasheet-working-application-alternative">KY-040</a> shown in Figure <a href="#fig:ky-040">2</a> .</p>
<div id="fig:ky-040" class="fignos">
<figure>
<img src="ky-040-rotary-encoder.jpg" alt="Figure 2: Mechanical Encoder KY-040" /><figcaption><span>Figure 2:</span> Mechanical Encoder KY-040</figcaption>
</figure>
</div>
<p>Compared to optical encoders, mechanical encoders are much cheaper but also more prone to noise associated with the mechanical interface. We will see the effect of mechanical noise on the ability to capture the knob position as it’s rotated.</p>
<p>Magnetometers or hall effect sensors and rotating magnetic fields are also used for rotational sensor encoding, especially in <a href="https://www.ti.com/lit/an/slvaeg3a/slvaeg3a.pdf">3-phase DC motor commutation</a>. Encoded magnetic strips are also used in linear sensing applications. This lab will be focused on a low-cost mechanical rotary encoder and the next part will use a hall effect rotary encoder on a DC motor.</p>
<h3 id="quadrature-and-absolute-encoders">Quadrature and Absolute Encoders</h3>
<p>The disadvantage of using an incremental encoder is that the pulsing provided by the sensor in one direction is indistinguishable from motion in the opposite direction. Single channel incremental encoders are more useful for applications with one direction of motion.</p>
<p>For position feedback and determining the direction of rotation, a <strong>quadrature encoder</strong> solves the problem by adding a row of on/off signals in the physical interface with an offset such that the direction can be determined. Refer to Figure <a href="#fig:quad-code-animation">3</a> which shows the operation of a quadrature encoder and the resulting two signals A and B that follow from a clockwise rotation. Figure <a href="#fig:quadrature-diagram">4</a> shows the resulting signal from rotation in clockwise and counter-clockwise directions.</p>
<div id="fig:quad-code-animation" class="fignos">
<figure>
<img src="incremental-directional-encoder.gif" alt="Figure 3: Quadrature code change in clockwise direction" /><figcaption><span>Figure 3:</span> Quadrature code change in clockwise direction</figcaption>
</figure>
</div>
<!-- ![Quadrature A/B Signal Progression](quadrature-overview.jpg){ width=300px } -->
<div id="fig:quadrature-diagram" class="fignos">
<figure>
<img src="quadrature-diagram.svg" alt="Figure 4: Quadrature A/B signal pulses" /><figcaption><span>Figure 4:</span> Quadrature A/B signal pulses</figcaption>
</figure>
</div>
<h3 id="gray-code-decoding">Gray-Code Decoding</h3>
<p>When the A and B signals arrive from a quadrature encoder, we need to interpret the sequence of high and low signals from both lines to generate a change in value. This is the decoding process.</p>
<p>It is convenient to interpret the two signals in an incremental quadrature encoder as a 2-bit code. The first least significant bit (LSB: the right-most bit in most programming languages) signifies the B value as either ON (1) or OFF (0). The next bit contains the value of the A signal. We can therefore assign a change in value according to the sequence of bits that are received from the encoder.</p>
<p>The progression of the 2-bit code is as follows:</p>
<table>
<thead>
<tr class="header">
<th>Direction</th>
<th>Sequence</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>CW</td>
<td><span class="math inline">\(00\rightarrow01\rightarrow11\rightarrow10\)</span></td>
</tr>
<tr class="even">
<td>CCW</td>
<td><span class="math inline">\(00\rightarrow10\rightarrow11\rightarrow01\)</span></td>
</tr>
</tbody>
</table>
<p>From these state transitions, given the current state of the A and B inputs, and the next state when either signal changes, we can compute the increment of pulse count in positive or negative direction. With only one bit changing at a time, this sequence is referred to as a 2-bit <a href="https://en.wikipedia.org/wiki/Gray_code"><strong>Gray Code</strong></a>.</p>
<p>However, this sequence is only valid if one bit changes. If two bits change at the same time, it is an invalid sequence where there is no way to tell if there was a clockwise or counter-clockwise turn to reach this state. The following Table describes the possible state transitions. For the invalid transitions, instead of aborting the process, we can make an assumption that the direction is the same as the previous transition but advances by 2 steps in the direction of travel instead of just one.</p>
<table>
<thead>
<tr class="header">
<th>Transitions</th>
<th>Diagram</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>Forward Movement (+1)</td>
<td><img src="EncoderStatesForward.png" title="fig:" alt="Transition: Forward" width="200" /></td>
</tr>
<tr class="even">
<td>Reverse Movement (-1)</td>
<td><img src="EncoderStatesReverse.png" title="fig:" alt="Transition: Reverse" width="200" /></td>
</tr>
<tr class="odd">
<td>No Movement (0)</td>
<td><img src="EncoderStatesStationary.png" title="fig:" alt="Transition: Stationary" width="200" /></td>
</tr>
<tr class="even">
<td>Invalid Motion (<span class="math inline">\(\pm 2\)</span>)</td>
<td><img src="EncoderStatesError.png" title="fig:" alt="Transition: Error" width="200" /></td>
</tr>
</tbody>
</table>
<p>The number of edges counted (state transitions) per each revolution of the rotary encoder provides the resolution of the encoder in <strong>Counts Per Revolution (CPR)</strong>. A higher resolution may provide better precision of an angle measurement, but if the encoder is spinning too fast, the frequency of the pulses that need to be counted per second increases and may exceed the capabilities of the decoder (counter) and counts can be missed.</p>
<p>In the lab with the motion control application (part 2), we will investigate the relationship between the motor RPM and pulse frequency of the encoder. They are important factors in designing a feedback control system using rotary encoders. For this lab, we not as concerned with keeping an accurate absolute position count and missed steps are tolerable.</p>
<!--
For more information, the following online resources are hel

- [https://eltra-encoder.eu/news/quadrature-encoder]()
- [https://en.wikipedia.org/wiki/Incremental_encoder]()
- [http://engineering.nyu.edu/mechatronics/Control_Lab/Criag/Craig_RPI/SenActinMecha/S&A_Optical_Encoders.pdf](
http://engineering.nyu.edu/mechatronics/Control_Lab/Criag/Craig_RPI/SenActinMecha/S&A_Optical_Encoders.pdf) -->
<h2 id="materials">Materials</h2>
<p>The two modules connected to the GPIO for this lab are a rotary encoder input and a simple readout display. The list of materials are provided in Table <a href="#tbl:materials-list">1</a>.</p>
<blockquote>
<p><strong>NOTE</strong>: Many Adafruit or Sparkfun branded modules have generic versions that may be more affordable and/or have faster shipping from alternative suppliers.</p>
</blockquote>
<p>Wire up the components as shown in Figure <a href="#fig:wiring-schematic">5</a>. The encoder A and B wires are connected to GPIO 6 and 13, respectively. The encoder push-button switch is connected to GPIO 5 but is unused in this lab. The OLED display is an I2C device and is connected to SDA and SCL pins on the GPIO. Power is only 3.3V, be careful to never use the 5V power unless it’s for an external device not connected to the GPIO (such as a fan).</p>
<div id="tbl:materials-list" class="tablenos">
<table>
<caption><span>Table 1:</span> List of materials. </caption>
<thead>
<tr class="header">
<th>Item</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><a href="https://www.raspberrypi.com/products/raspberry-pi-4-model-b/">Raspberry Pi</a></td>
<td>Raspberry Pi 4, 3B, or Zero W2</td>
</tr>
<tr class="even">
<td><a href="https://www.adafruit.com/product/931">SSD1306 I2C OLED 128x32 Display</a></td>
<td>A simple display for readout</td>
</tr>
<tr class="odd">
<td><a href="https://components101.com/modules/KY-04-rotary-encoder-pinout-features-datasheet-working-application-alternative">KY-040 Quadrature Encoder</a></td>
<td>A knob for manual incremental encoder counting</td>
</tr>
<tr class="even">
<td>Breadboard</td>
<td>For prototyping</td>
</tr>
<tr class="odd">
<td>Jumper Wire</td>
<td>For prototyping</td>
</tr>
<tr class="even">
<td>USB Power Supply</td>
<td>Power for the Raspberry Pi</td>
</tr>
</tbody>
</table>
</div>
<div id="fig:wiring-schematic" class="fignos">
<figure>
<img src="lab7-wiring-schematic.svg" alt="Figure 5: Wiring Diagram" /><figcaption><span>Figure 5:</span> Wiring Diagram</figcaption>
</figure>
</div>
<h2 id="methods">Methods</h2>
<h3 id="raspberry-pi-system-software-prerequisites">Raspberry Pi System Software Prerequisites</h3>
<ol type="1">
<li><p>Install python and git</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode bash"><code class="sourceCode bash"><a class="sourceLine" id="cb1-1" title="1"><span class="fu">sudo</span> apt install -y \</a>
<a class="sourceLine" id="cb1-2" title="2">    git \</a>
<a class="sourceLine" id="cb1-3" title="3">    python3 \</a>
<a class="sourceLine" id="cb1-4" title="4">    python3-pip \</a>
<a class="sourceLine" id="cb1-5" title="5">    python3-venv \</a>
<a class="sourceLine" id="cb1-6" title="6">    python3-setuptools \</a>
<a class="sourceLine" id="cb1-7" title="7">    python3-flake8 \</a>
<a class="sourceLine" id="cb1-8" title="8">    python3-flake8-docstrings \</a>
<a class="sourceLine" id="cb1-9" title="9">    python3-autopep8 \</a>
<a class="sourceLine" id="cb1-10" title="10">    python3-rpi.gpio</a></code></pre></div></li>
<li><p>Enable i2C in <code>raspi-config</code></p>
<div class="sourceCode" id="cb2"><pre class="sourceCode bash"><code class="sourceCode bash"><a class="sourceLine" id="cb2-1" title="1"><span class="fu">sudo</span> raspi-config</a></code></pre></div>
<p>Set <code>3 Interface Options -&gt; I5 I2C</code> to <code>Yes</code>.</p>
<p>Check that i2c is available</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode bash"><code class="sourceCode bash"><a class="sourceLine" id="cb3-1" title="1"><span class="fu">ls</span> -l /dev/i2c*</a></code></pre></div>
<p>Show connected devices</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode bash"><code class="sourceCode bash"><a class="sourceLine" id="cb4-1" title="1"><span class="ex">i2cdetect</span> -y 1</a></code></pre></div></li>
<li><p>Update i2C bitrate</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode bash"><code class="sourceCode bash"><a class="sourceLine" id="cb5-1" title="1"><span class="bu">echo</span> <span class="st">&quot;dtparam=i2c_baudrate=1000000&quot;</span> <span class="kw">|</span> <span class="fu">sudo</span> tee -a /boot/config.txt</a></code></pre></div>
<p>Reboot the module.</p></li>
<li><p>Update bash config with local directory <code>~/.local</code> added to <code>PATH</code> environment variable</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode bash"><code class="sourceCode bash"><a class="sourceLine" id="cb6-1" title="1"><span class="fu">mkdir</span> -p <span class="st">&quot;</span><span class="va">${HOME}</span><span class="st">/.local/bin&quot;</span></a>
<a class="sourceLine" id="cb6-2" title="2"><span class="bu">echo</span> <span class="st">&quot;source </span><span class="va">${HOME}</span><span class="st">/.bashrc&quot;</span> <span class="op">&gt;&gt;</span> <span class="va">${HOME}</span>/.bash_profile</a>
<a class="sourceLine" id="cb6-3" title="3"><span class="bu">echo</span> <span class="st">&quot;export PYTHONPATH=</span><span class="dt">\$</span><span class="st">PYTHONPATH:/usr/local/lib/python3.9/site-packages&quot;</span> <span class="op">&gt;&gt;</span> <span class="va">${HOME}</span>/.bash_profile</a>
<a class="sourceLine" id="cb6-4" title="4"><span class="bu">echo</span> <span class="st">&quot;export PATH=</span><span class="dt">\$</span><span class="st">PATH:</span><span class="va">${HOME}</span><span class="st">/.local/bin&quot;</span> <span class="op">&gt;&gt;</span> <span class="va">${HOME}</span>/.bash_profile</a></code></pre></div></li>
</ol>
<h3 id="lab-software-requirements">Lab Software Requirements</h3>
<p>On the Raspberry Pi, install <a href="https://matplotlib.org/">matplotlib</a> for plotting, <a href="https://pillow.readthedocs.io/en/stable/">pillow</a> library for LED screen imaging, and <a href="https://scipy.org/">scipy</a> with <a href="https://numpy.org/">numpy</a> for numerical processing.</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode bash"><code class="sourceCode bash"><a class="sourceLine" id="cb7-1" title="1"><span class="fu">sudo</span> apt install -y \</a>
<a class="sourceLine" id="cb7-2" title="2">    python3-scipy \</a>
<a class="sourceLine" id="cb7-3" title="3">    python3-numpy \</a>
<a class="sourceLine" id="cb7-4" title="4">    python3-matplotlib \</a>
<a class="sourceLine" id="cb7-5" title="5">    python3-pil</a></code></pre></div>
<p>Install Python packages <a href="https://github.com/mivallion/Encoder">Encoder</a> and <a href="https://docs.circuitpython.org/projects/ssd1306/en/stable/">adafruit-circuitpython-ssd1306</a> for the OLED display hardware interface.</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode bash"><code class="sourceCode bash"><a class="sourceLine" id="cb8-1" title="1"><span class="ex">python3</span> -m pip install --user \</a>
<a class="sourceLine" id="cb8-2" title="2">    Encoder \</a>
<a class="sourceLine" id="cb8-3" title="3">    adafruit-circuitpython-ssd1306</a></code></pre></div>
<p>Use VS Code with Python extension for development.</p>
<blockquote>
<p><strong>NOTE</strong>: If you do not want to use the Raspberry Pi desktop environment, use VS Code on your personal computer with <a href="https://marketplace.visualstudio.com/items?itemName=ms-vscode-remote.vscode-remote-extensionpack">remote development extension pack</a> to <a href="https://code.visualstudio.com/docs/remote/ssh">develop on the pi over a local SSH network connection</a>.</p>
</blockquote>
<h3 id="test-the-hardware-and-run-python-scripts">Test The Hardware and Run Python Scripts</h3>
<p>Check out the git repo <a href="https://github.com/chishok/ENG8905-Lab7">https://github.com/chishok/ENG8905-Lab7</a> and open the folder in VS Code.</p>
<ol type="1">
<li><p>Get familiar with how to <strong>use the <code>Encoder</code> python package and the GPIO</strong>. Read and run the script <a href="https://github.com/chishok/ENG8905-Lab7/blob/master/scripts/EncoderSample.py">scripts/DatalogPlotSample.py</a>:</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode bash"><code class="sourceCode bash"><a class="sourceLine" id="cb9-1" title="1"><span class="ex">python3</span> scripts/DatalogPlotSample.py</a></code></pre></div>
<p>A printout in the terminal will show the current value of the encoder at a regular interval (10Hz refresh rate). Rotate the encoder knob and the updated count will be displayed. The package which was installed to count the encoder is hosted on GitHub here: <a href="https://github.com/mivallion/Encoder">https://github.com/mivallion/Encoder</a>. The next task in this lab is to implement our own decoding logic and compare it against this package.</p></li>
<li><p><strong>Use the display</strong>. Read and run the script <a href="https://github.com/chishok/ENG8905-Lab7/blob/master/scripts/DisplaySample.py">scripts/DisplaySample.py</a>:</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode bash"><code class="sourceCode bash"><a class="sourceLine" id="cb10-1" title="1"><span class="ex">python3</span> scripts/DisplaySample.py</a></code></pre></div>
<p>You should see the text “Hello World!” displayed on the small OLED display with a border surrounding the text. Inside the script, change the line</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode python"><code class="sourceCode python"><a class="sourceLine" id="cb11-1" title="1">text <span class="op">=</span> <span class="st">&quot;Hello World!&quot;</span></a></code></pre></div>
<p>to another message and re-run. Do you see the updated text?</p></li>
<li><p>Generate <strong>display output of running encoder in a timed loop</strong>. Read and run the script <a href="https://github.com/chishok/ENG8905-Lab7/blob/master/scripts/EncoderAndDisplaySample.py">scripts/EncoderAndDisplaySample.py</a>:</p>
<div class="sourceCode" id="cb12"><pre class="sourceCode bash"><code class="sourceCode bash"><a class="sourceLine" id="cb12-1" title="1"><span class="ex">python3</span> scripts/EncoderAndDisplaySample.py</a></code></pre></div>
<p>Rotate the knob and you should see the values updated on the OLED display.</p></li>
<li><p>Save, load, and plot data. Read and run the script <a href="https://github.com/chishok/ENG8905-Lab7/blob/master/scripts/DatalogPlotSample.py">scripts/DatalogPlotSample.py</a>:</p>
<div class="sourceCode" id="cb13"><pre class="sourceCode bash"><code class="sourceCode bash"><a class="sourceLine" id="cb13-1" title="1"><span class="ex">python3</span> scripts/DatalogPlotSample.py</a></code></pre></div>
<p>This will generate an image file of the plot called <code>plot_output.png</code> with simulated noisy sinusoidal and filtered data. The plot should look like:</p>
<figure>
<img src="sample-plot.png" alt="Sample plot of filtered sinusoidal" /><figcaption>Sample plot of filtered sinusoidal</figcaption>
</figure></li>
</ol>
<p>The code samples in the scripts folder have been repurposed in a folder named <a href="https://github.com/chishok/ENG8905-Lab7/tree/master/encoder">encoder</a> which contains multiple python files and classes. You are encouraged to read through the entire source code, but the focus of the lab will be to modify a portion of the <a href="https://github.com/chishok/ENG8905-Lab7/blob/master/encoder/quadrature.py">encoder/quadrature.py</a> file which handles the quadrature encoder counting.</p>
<h3 id="coding-task-decode-quadrature-input">Coding Task: Decode Quadrature Input</h3>
<p>Run the encoder module. Make sure the current directory is the root of the workspace (project folder) and create a <code>data</code> subfolder then run the module</p>
<div class="sourceCode" id="cb14"><pre class="sourceCode bash"><code class="sourceCode bash"><a class="sourceLine" id="cb14-1" title="1"><span class="fu">mkdir</span> -p data</a>
<a class="sourceLine" id="cb14-2" title="2"><span class="va">PYTHONPATH=</span>. <span class="ex">python3</span> encoder --output <span class="st">&quot;data/dataLogEncoder&quot;</span></a></code></pre></div>
<blockquote>
<p><strong>NOTE</strong>: The environment variable <code>PYTHONPATH=.</code> before running python ensure the module folder <code>encoder</code> is on the python’s search path.</p>
</blockquote>
<p>When the command is run, the encoder and display are active for 15 seconds. While it’s running, rotate the knob and watch the output angle values. Figure <a href="#fig:data-acquisition-screen">6</a> shows a sample of what the readout looks like. Do the readout degrees correspond to the rotation of the knob? At the end of the duration, the program writes out data and exits. The data folder should contain two plots and a data file:</p>
<pre class="text"><code>data/dataLogEncoder_position.png
data/dataLogEncoder_timing.png
data/dataLogEncoder.npz</code></pre>
<div id="fig:data-acquisition-screen" class="fignos">
<figure>
<img src="data-acquisition-screen.png" alt="Figure 6: Data acquisition readout." /><figcaption><span>Figure 6:</span> Data acquisition readout.</figcaption>
</figure>
</div>
<p>Inspect the file <a href="https://github.com/chishok/ENG8905-Lab7/blob/master/encoder/configuration.py">encoder/configuration.py</a> to see what the default configured values are for the encoder nad display. Some command line arguments override the configured default values. Inspect the file <a href="https://github.com/chishok/ENG8905-Lab7/blob/master/encoder/__main__.py">encoder/__main__.py</a> to see what arguments can be passed when running <code>python3 encoder</code>.</p>
<p>Modify the source file <a href="https://github.com/chishok/ENG8905-Lab7/blob/master/encoder/quadrature.py">encoder/quadrature.py</a> to implement the quadrature decoding logic in between the comments</p>
<div class="sourceCode" id="cb16"><pre class="sourceCode python"><code class="sourceCode python"><a class="sourceLine" id="cb16-1" title="1"><span class="co"># STUDENT WORK SECTION </span><span class="re">BEGIN</span></a>
<a class="sourceLine" id="cb16-2" title="2"><span class="co"># ==========================</span></a></code></pre></div>
<p>and</p>
<div class="sourceCode" id="cb17"><pre class="sourceCode python"><code class="sourceCode python"><a class="sourceLine" id="cb17-1" title="1"><span class="co"># STUDENT WORK SECTION </span><span class="re">END</span></a>
<a class="sourceLine" id="cb17-2" title="2"><span class="co"># ========================</span></a></code></pre></div>
<p>Re-run the program with the argument <code>--custom-decoder</code> to test your implementation:</p>
<div class="sourceCode" id="cb18"><pre class="sourceCode bash"><code class="sourceCode bash"><a class="sourceLine" id="cb18-1" title="1"><span class="va">PYTHONPATH=</span>. <span class="ex">python3</span> encoder --output <span class="st">&quot;data/dataLogCustom&quot;</span> --custom-decoder</a></code></pre></div>
<h3 id="data-collection">Data Collection</h3>
<p>Run the data collection script</p>
<div class="sourceCode" id="cb19"><pre class="sourceCode bash"><code class="sourceCode bash"><a class="sourceLine" id="cb19-1" title="1"><span class="ex">./scripts/Lab7/scripts/run_data_collection.sh</span></a></code></pre></div>
<p>Follow the prompts in the terminal. You will be prompted to turn the encoder knob to +360 then reverse to -360 and back to 0 over 15 seconds a total of 4 times. Don’t start to turn the knob until the printout The following files are generated when the script is completed:</p>
<pre class="text"><code>data/dataLogEncoder_position.png
data/dataLogEncoder_timing.png
data/dataLogEncoder.npz
data/dataLogCustom_position.png
data/dataLogCustom_timing.png
data/dataLogCustom.npz
data/dataLogEncoder200Hz_position.png
data/dataLogEncoder200Hz_timing.png
data/dataLogEncoder200Hz.npz
data/dataLogCustom200Hz_position.png
data/dataLogCustom200Hz_timing.png
data/dataLogCustom200Hz.npz</code></pre>
<h2 id="analysis">Analysis</h2>
<p>Example output</p>
<div id="fig:position-50hz" class="fignos">
<figure>
<img src="dataLogEncoder_position.png" alt="Figure 7: Example of position data output at 50Hz sampling rate." /><figcaption><span>Figure 7:</span> Example of position data output at 50Hz sampling rate.</figcaption>
</figure>
</div>
<div id="fig:position-200hz" class="fignos">
<figure>
<img src="dataLogEncoder200Hz_position.png" alt="Figure 8: Example of position data output at 200Hz sampling rate." /><figcaption><span>Figure 8:</span> Example of position data output at 200Hz sampling rate.</figcaption>
</figure>
</div>
<h2 id="submission-guidelines">Submission Guidelines</h2>                    
                </div>
            </div>
            <script src="https://vjs.zencdn.net/5.4.4/video.js"></script>
        </div>
    </body>
</html>
